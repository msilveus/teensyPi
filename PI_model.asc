Version 4
SHEET 1 6420 1888
WIRE 2704 -240 2704 -272
WIRE 2704 -240 2560 -240
WIRE 2704 -192 2704 -240
WIRE 2656 -176 2624 -176
WIRE 2560 -160 2560 -240
WIRE 4000 -144 3968 -144
WIRE 4096 -144 4064 -144
WIRE 3648 -112 3568 -112
WIRE 3792 -112 3744 -112
WIRE 3824 -112 3792 -112
WIRE 3936 -112 3904 -112
WIRE 3968 -112 3968 -144
WIRE 3968 -112 3936 -112
WIRE 4096 -112 4096 -144
WIRE 4128 -112 4096 -112
WIRE 3648 -80 3616 -80
WIRE 3968 -80 3968 -112
WIRE 4000 -80 3968 -80
WIRE 4096 -80 4096 -112
WIRE 4096 -80 4080 -80
WIRE 4272 -80 4240 -80
WIRE 4400 -80 4352 -80
WIRE 4448 -80 4400 -80
WIRE 4560 -80 4528 -80
WIRE 4656 -80 4640 -80
WIRE 3072 -48 3008 -48
WIRE 3184 -48 3152 -48
WIRE 3232 -48 3184 -48
WIRE 3344 -48 3312 -48
WIRE 2560 -32 2560 -80
WIRE 2624 -32 2624 -176
WIRE 2624 -32 2560 -32
WIRE 2704 -32 2704 -96
WIRE 3616 -32 3616 -80
WIRE 4656 -32 4656 -80
WIRE 4656 -32 4592 -32
WIRE 4816 -32 4784 -32
WIRE 4960 -32 4896 -32
WIRE 3696 -16 3696 -48
WIRE 4784 -16 4784 -32
WIRE 2560 0 2560 -32
WIRE 3344 0 3344 -48
WIRE 3792 0 3792 -112
WIRE 4960 0 4960 -32
WIRE 4896 16 4848 16
WIRE 4928 16 4896 16
WIRE 4128 32 4128 -112
WIRE 4400 32 4400 -80
WIRE 4416 32 4400 32
WIRE 5088 32 4992 32
WIRE 3936 48 3936 -112
WIRE 4000 48 3936 48
WIRE 4592 48 4592 -32
WIRE 4592 48 4480 48
WIRE 4624 48 4592 48
WIRE 4736 48 4704 48
WIRE 4768 48 4736 48
WIRE 4864 48 4832 48
WIRE 4928 48 4864 48
WIRE 5088 48 5088 32
WIRE 3184 64 3184 -48
WIRE 3200 64 3184 64
WIRE 4128 64 4128 32
WIRE 4128 64 4064 64
WIRE 4160 64 4128 64
WIRE 4304 64 4240 64
WIRE 4368 64 4304 64
WIRE 4416 64 4368 64
WIRE 3344 80 3344 0
WIRE 3344 80 3264 80
WIRE 3376 80 3344 80
WIRE 3472 80 3440 80
WIRE 3552 80 3472 80
WIRE 3568 80 3568 -112
WIRE 3568 80 3552 80
WIRE 4000 80 3936 80
WIRE 2704 96 2704 32
WIRE 2832 96 2704 96
WIRE 2896 96 2832 96
WIRE 2976 96 2896 96
WIRE 3120 96 3056 96
WIRE 3200 96 3120 96
WIRE 4960 96 4960 64
WIRE 4736 112 4736 48
WIRE 2704 128 2704 96
WIRE 3472 176 3472 80
WIRE 4368 176 4368 64
WIRE 4368 176 4288 176
WIRE 4864 176 4864 48
WIRE 4944 176 4864 176
WIRE 5088 176 4944 176
WIRE 2560 192 2560 80
WIRE 4288 192 4288 176
WIRE 4368 192 4368 176
WIRE 4864 192 4864 176
WIRE 2832 208 2832 96
WIRE 3120 208 3120 96
WIRE 3120 208 3072 208
WIRE 3168 208 3120 208
WIRE 4000 208 3968 208
WIRE 4096 208 4064 208
WIRE 2304 240 2288 240
WIRE 2432 240 2384 240
WIRE 2496 240 2432 240
WIRE 3568 240 3568 80
WIRE 3664 240 3568 240
WIRE 3792 240 3760 240
WIRE 3808 240 3792 240
WIRE 3936 240 3936 80
WIRE 3936 240 3888 240
WIRE 3968 240 3968 208
WIRE 3968 240 3936 240
WIRE 4096 240 4096 208
WIRE 4144 240 4096 240
WIRE 2432 272 2432 240
WIRE 3120 272 3072 272
WIRE 3168 272 3120 272
WIRE 3664 272 3616 272
WIRE 3968 272 3968 240
WIRE 4000 272 3968 272
WIRE 4096 272 4096 240
WIRE 4096 272 4080 272
WIRE 4144 272 4144 240
WIRE 4864 272 4864 256
WIRE 4944 272 4944 256
WIRE 4944 272 4864 272
WIRE 2704 288 2704 208
WIRE 2832 288 2704 288
WIRE 4288 288 4288 256
WIRE 4368 288 4368 272
WIRE 4368 288 4288 288
WIRE 4864 288 4864 272
WIRE 2704 304 2704 288
WIRE 3120 304 3120 272
WIRE 3472 304 3472 256
WIRE 3616 304 3616 272
WIRE 4368 304 4368 288
WIRE 2560 336 2560 288
WIRE 3712 336 3712 304
WIRE 3792 368 3792 240
WIRE 2432 400 2432 352
WIRE 2736 448 2640 448
WIRE 2880 448 2816 448
WIRE 2640 496 2640 448
WIRE 2880 496 2880 448
WIRE 2592 512 2448 512
WIRE 4016 512 3840 512
WIRE 2448 528 2448 512
WIRE 3840 528 3840 512
WIRE 2592 560 2528 560
WIRE 2448 640 2448 608
WIRE 2528 640 2528 560
WIRE 2528 640 2448 640
WIRE 2576 640 2528 640
WIRE 2640 640 2640 576
WIRE 2640 640 2576 640
WIRE 2880 640 2880 576
WIRE 2880 640 2640 640
WIRE 3840 640 3840 608
WIRE 3360 672 3360 624
WIRE 3504 672 3504 624
WIRE 3648 672 3648 640
WIRE 2576 688 2576 640
WIRE 4000 688 3840 688
WIRE 3840 704 3840 688
WIRE 3360 800 3360 752
WIRE 3504 800 3504 752
WIRE 3504 800 3360 800
WIRE 3648 800 3648 752
WIRE 3648 800 3504 800
WIRE 3840 816 3840 784
WIRE 3360 832 3360 800
WIRE 3504 864 3504 800
WIRE 4000 864 3840 864
WIRE 3840 880 3840 864
WIRE 3360 960 3360 912
WIRE 3840 992 3840 960
FLAG 3472 304 0
FLAG 3504 864 0
FLAG 3360 624 +5V
FLAG 3360 960 -5V
FLAG 3504 624 +12V
FLAG 2560 336 0
FLAG 2704 -272 +12V
FLAG 2704 304 0
FLAG 4032 32 +5V
FLAG 4032 96 -5V
FLAG 4144 272 0
FLAG 2432 400 0
FLAG 2288 240 txPulse
FLAG 3232 48 +5V
FLAG 3232 112 -5V
FLAG 3008 -48 0
FLAG 3120 304 0
FLAG 2896 96 Vcoil
FLAG 3120 96 Vclamp
FLAG 3344 0 Vamp
FLAG 2576 688 0
FLAG 4128 32 Vint
FLAG 4368 304 0
FLAG 4784 -16 0
FLAG 5088 32 beep_control
FLAG 3552 80 Intg_In
FLAG 4016 512 txPulse
FLAG 3840 640 0
FLAG 3840 816 0
FLAG 3840 992 0
FLAG 4000 688 mainCtrl
FLAG 4000 864 efeCtrl
FLAG 3616 -32 mainCtrl
FLAG 3616 304 efeCtrl
FLAG 3696 -16 0
FLAG 3712 336 0
FLAG 4960 96 0
FLAG 4448 80 0
FLAG 4304 128 0
FLAG 3648 640 +3.3V
FLAG 4960 -32 +3.3V
FLAG 4448 16 +3.3V
FLAG 4304 0 0
FLAG 4368 64 Buf_In
FLAG 4864 288 0
FLAG 5088 176 A0/PeakDet
FLAG 3696 -160 +3.3V
FLAG 5088 128 0
FLAG 3792 0 mainSig
FLAG 3792 368 efeSig
FLAG 4240 -80 0
FLAG 4736 176 0
FLAG 3712 192 +3.3V
FLAG 4896 16 A1
SYMBOL pmos 2656 -96 M180
SYMATTR InstName M1
SYMATTR Value IRF9640
SYMBOL npn 2496 192 R0
SYMATTR InstName Q1
SYMATTR Value 2N3904
SYMBOL res 3920 -128 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 1k
SYMBOL res 3904 224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R12
SYMATTR Value 1k
SYMBOL res 3456 160 R0
SYMATTR InstName R9
SYMATTR Value 100K
SYMBOL voltage 3360 656 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V1
SYMATTR Value 5
SYMBOL voltage 3360 816 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V2
SYMATTR Value 5
SYMBOL voltage 3504 656 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V3
SYMATTR Value 12
SYMBOL res 2544 -176 R0
SYMATTR InstName R4
SYMATTR Value 1k
SYMBOL res 2544 -16 R0
SYMATTR InstName R3
SYMATTR Value 150
SYMBOL ind2 2816 192 R0
WINDOW 0 41 34 Left 2
WINDOW 3 36 68 Left 2
SYMATTR InstName L1
SYMATTR Value 300µ
SYMATTR Type ind
SYMBOL res 2688 112 R0
SYMATTR InstName Rdamp
SYMATTR Value 330
SYMBOL cap 4064 192 R90
WINDOW 0 12 58 VBottom 2
WINDOW 3 -12 -13 VTop 2
SYMATTR InstName C3
SYMATTR Value 470n
SYMBOL res 4096 256 R90
WINDOW 0 47 106 VBottom 2
WINDOW 3 32 47 VTop 2
SYMATTR InstName R13
SYMATTR Value 270k
SYMBOL cap 4064 -160 R90
WINDOW 0 13 66 VBottom 2
WINDOW 3 -12 -11 VTop 2
SYMATTR InstName C2
SYMATTR Value 470n
SYMBOL res 4096 -96 R90
WINDOW 0 48 104 VBottom 2
WINDOW 3 31 46 VTop 2
SYMATTR InstName R11
SYMATTR Value 270k
SYMBOL res 2416 256 R0
SYMATTR InstName R2
SYMATTR Value 10K
SYMBOL res 3328 -64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 -60 56 VTop 2
SYMATTR InstName R8
SYMATTR Value 1Meg
SYMBOL res 3168 -64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 36 57 VTop 2
SYMATTR InstName R7
SYMATTR Value 1.5K
SYMBOL res 3072 80 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R5
SYMATTR Value 1.2K
SYMBOL ind2 2864 480 R0
SYMATTR InstName L2
SYMATTR Value 360µ
SYMATTR Type ind
SYMBOL sw 2640 592 M180
SYMATTR InstName S1
SYMATTR Value ArmSwing
SYMBOL res 2832 432 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R20
SYMATTR Value 10
SYMBOL voltage 2448 512 R0
WINDOW 3 -420 56 Left 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR Value PULSE(0 1 1 1u 1u 100m 200m 5)
SYMATTR InstName V5
SYMBOL res 4352 176 R0
SYMATTR InstName R15
SYMATTR Value 100K
SYMBOL CD4066 3696 -96 R0
WINDOW 3 -71 -89 Top 2
SYMATTR InstName U2a
SYMBOL CD4066 3712 256 R0
WINDOW 3 -73 -94 Top 2
SYMATTR InstName U2b
SYMBOL voltage 3840 512 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V4
SYMATTR Value PULSE(0 3.1 {TxDelay} 1n 1n {TxPulseWidth} {Period})
SYMBOL voltage 3840 688 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V7
SYMATTR Value PULSE(0 3.3 {MainDelay} 1n 1n {RxPulseWidth} {Period})
SYMBOL voltage 3840 864 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V8
SYMATTR Value PULSE(0 3.3 {EFEDelay} 1n 1n {RxPulseWidth} {Period})
SYMBOL OpAmps\\LT1677 3232 16 R0
SYMATTR InstName U1
SYMBOL OpAmps\\LT1677 4032 0 R0
SYMATTR InstName U3
SYMBOL OpAmps\\LT1677 4448 -16 R0
SYMATTR InstName U4
SYMBOL res 4256 48 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R14
SYMATTR Value 150
SYMBOL voltage 3648 656 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V9
SYMATTR Value 3.3
SYMBOL zener 4288 0 R0
WINDOW 0 -38 37 Left 2
WINDOW 3 -98 6 Left 2
SYMATTR InstName D4
SYMATTR Value 1N5225
SYMBOL cap 4848 192 R0
SYMATTR InstName C4
SYMATTR Value 1µ
SYMBOL res 4928 160 R0
SYMATTR InstName R18
SYMATTR Value 100K
SYMBOL potentiometer 4912 -48 R90
WINDOW 0 -14 10 VRight 2
WINDOW 3 -46 -46 VRight 2
SYMATTR InstName R16
SYMATTR Value Rtot=10K wiper=.075
SYMBOL cap 3440 64 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C1
SYMATTR Value .1µ
SYMBOL diode 2688 -32 R0
WINDOW 0 27 57 Left 2
WINDOW 3 26 2 Left 2
SYMATTR InstName D6
SYMATTR Value RFN5BGE3S
SYMBOL res 5072 32 R0
SYMATTR InstName R17
SYMATTR Value 100K
SYMBOL res 2400 224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R1
SYMATTR Value 1K
SYMBOL cap 4272 192 R0
SYMATTR InstName C5
SYMATTR Value 10µ
SYMBOL diode 3088 208 M0
SYMATTR InstName D1
SYMATTR Value 1N4148
SYMBOL diode 3152 272 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D2
SYMATTR Value 1N4148
SYMBOL diode 4768 64 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D7
SYMATTR Value DRBE01VYM6A
SYMBOL res 4544 -96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value 50K
SYMBOL res 4368 -96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R21
SYMATTR Value 10K
SYMBOL potentiometer 4656 -96 R90
WINDOW 0 -5 -10 VRight 2
WINDOW 3 -46 -46 VRight 2
SYMATTR InstName R19
SYMATTR Value Rtot=1Meg wiper=.99
SYMBOL res 4720 32 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R22
SYMATTR Value 3.3K
SYMBOL cap 4720 112 R0
WINDOW 3 45 45 Left 2
SYMATTR Value 0.47µ
SYMATTR InstName C6
SYMBOL diode 4320 128 R180
WINDOW 0 38 31 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D5
SYMATTR Value DRBE01VYM6A
SYMBOL MCP6541 4960 -32 R0
SYMATTR InstName U2
TEXT 2440 728 Left 2 !.model ArmSwing SW(Ron=1m Roff=1000Meg Vt=0.5 Vh=.01)
TEXT 2760 336 Left 3 ;Search Coil
TEXT 2984 536 Left 3 ;Model of\nNon-ferrous\nmetallic target
TEXT 3344 520 Left 2 ;Power Supplies
TEXT 1968 -72 Left 3 ;PI_model.asc
TEXT 2904 488 Left 2 !K1 L1 L2 0.002
TEXT 1968 -24 Left 2 !.tran 0 3 50u 1u startup\n.param TxDelay 0u\n.param TxPulseWidth 50u\n.param Period=1m\n.param Cycles 2000\n.param MainDelay {TxDelay+TxPulseWidth+68u}\n.param EFEDelay {MainDelay+250u}\n.param RxPulseWidth 10u
TEXT 2304 832 Left 2 !* CD4066 Analog Switch\n* SYM=CD4066\n* Transistor models are from LTspice group member kcin_melnick\n* See message number 16897, http://tech.groups.yahoo.com/group/LTspice/\n* Analog Switch Control In Out Vdd Vss\n.SUBCKT CD4066 2 11 4 10 7\nX1 2 6 10 7 INVERT\nX2 6 1 10 7 INVERT\nM1 14 6 7 7 CD4007N\nM7 11 6 14 10 CD4007P\nM3 11 1 14 14 CD4007N\nM4 11 1 4 14 CD4007N\nM8 11 6 4 10 CD4007P\n.SUBCKT INVERT 1 2 3 4\n* Inverter In Out Vcc Vss\nM1 2 1 3 3 CD4007P\nM2 2 1 4 4 CD4007N\n.ENDS\n.MODEL CD4007N NMOS (\n+ LEVEL=1 VTO=1.44 KP=320u L=10u W=30u GAMMA=0 PHI=.6 LAMBDA=10m\n+ RD=23.2 RS=90.1 IS=16.64p CBD=2.0p CBS=2.0p CGSO=0.1p CGDO=0.1p\n+ PB=.8 TOX=1200n)\n \n.MODEL CD4007P PMOS (\n+ LEVEL=1 VTO=-1.2 KP=110u L=10U W=60U GAMMA=0 PHI=.6 LAMBDA=40m\n+ RD=21.2 RS=62.2 IS=16.64P CBD=4.0P CBS=4.0P CGSO=0.2P CGDO=0.2P\n+ PB=.8 TOX=1200N)\n.ENDS
TEXT 4216 1080 Left 2 !.model 1N5225 D(\n+Is=.88f \n+Rs=.25 \n+Cjo=175p \n+M=.55 \n+nbv=1.7 \n+bv=3.0 \n+Vj=.75 \n+Isr=1.86n \n+Nr=2 \n+Ibv=20.245m \n+Ibvl=1.96m \n+Nbvl=15 \n+Tbv1=-21.3u \n+Vpk=3.0 \n+mfg=OnSemi \n+type=Zener)
TEXT 3856 -248 Left 2 !.param D3=1N5225
TEXT 3808 1088 Left 2 !* This is the potentiometer\n*      _____\n*  1--|_____|--2\n*        |\n*        3\n*\n.SUBCKT potentiometer 1 2 3\n.param w=limit(wiper,1m,.999)\nR0 1 3 {Rtot*(1-w)}\nR1 3 2 {Rtot*(w)}\n.ENDS
TEXT 3832 472 Left 2 ;MCU Signals
TEXT 4600 -48 Left 2 ;Gain
TEXT 4736 -64 Left 2 ;Threshold
TEXT 4656 376 Left 2 !B1 MeasureWindow 0 V = IF((time > {TxDelay+TxPulseWidth}) * (time < {TxDelay+TxPulseWidth+16u}), 1, 0)\n \nB2 CurrentDuringWindow 0 V = I(Rdamp) * V(MeasureWindow)\n.meas TRAN Integral_I_Rdamp INTEG V(CurrentDuringWindow)\n.meas TRAN Duration_Window INTEG V(MeasureWindow)\n.meas TRAN Avg_I_Rdamp PARAM Integral_I_Rdamp / Duration_Window\n.meas TRAN Min_Avg_I_Rdamp MIN Avg_I_Rdamp\n.meas TRAN Max_Avg_I_Rdamp MAX Avg_I_Rdamp
TEXT 4656 624 Left 2 !B3 PowerDuringWindow 0 V = V(Vcoil) * I(Rdamp) * V(MeasureWindow)\n.meas TRAN Integral_P_Rdamp INTEG V(PowerDuringWindow)\n.meas TRAN Avg_P_Rdamp PARAM Integral_P_Rdamp / Duration_Window\n.meas TRAN Min_Avg_P_Rdamp MIN Avg_P_Rdamp\n.meas TRAN Max_Avg_P_Rdamp MAX Avg_P_Rdamp\n.meas TRAN True_Avg_P_Rdamp PARAM Integral_P_Rdamp / {Period} * {Duration_Window} / {Period}
TEXT 4656 808 Left 2 !.meas TRAN Peak_Pos_Vcoil MAX V(Vcoil)\n.meas TRAN Peak_Neg_Vcoil MIN V(Vcoil)\n.meas TRAN Peak_Pos_I_Rdamp MAX I(Rdamp)\n.meas TRAN Peak_Neg_I_Rdamp MIN I(Rdamp)\n.meas TRAN Peak_Pos_I_L1 MAX I(L1)\n.meas TRAN Peak_Neg_I_L1 MIN I(L1) FROM {TxDelay+TxPulseWidth} TO {TxDelay+TxPulseWidth+16u}
TEXT 4664 992 Left 2 !.meas TRAN Peak_Pos_Vclamp MAX V(Vclamp) FROM 1m\n.meas TRAN Peak_Neg_Vclamp MIN V(Vclamp) FROM 1m
TEXT 2672 72 VRight 2 ;CMF60330R00FKEA
TEXT 4408 -176 Left 2 ;.step param Gval 1K 1Meg 100K
TEXT 4664 1056 Left 2 !.meas TRAN peak_Pos_D1 MAX I(D1) FROM 1m\n.meas TRAN peak_Pos_D2 MAX I(D2) FROM 1m\n.meas TRAN peak_Neg_D1 MIN I(D1) FROM 1m\n.meas TRAN peak_Neg_D2 MIN I(D2) FROM 1m
TEXT 3320 1088 Left 2 !* DRBE01VYM6A D model\n* Model Generated by ROHM\n* All Rights Reserved\n* Commercial Use or Resale Restricted\n* Date: 2024/04/03\n.MODEL DRBE01VYM6A D\n+ IS=8.8011E-6\n+ N=1.0313\n+ RS=0.1311\n+ IKF=1.1129\n+ XTI=2.0\n+ EG=0.56\n+ CJO=168.61E-12\n+ M=0.5455\n+ VJ=0.5\n+ ISR=2.8111E-6\n+ NR=1.0811\n+ BV=6\n+ TRS1=0.004
TEXT 4616 112 Left 2 ;RC Filter
TEXT 2904 424 Left 2 ;Note: The best case coupling coeefficient of 0.002 \nshould simulate a quarter at about 30cm in air
TEXT 4408 120 Left 2 ;Min gain is x6\nMax gain is x106
TEXT 4920 -160 Left 2 !.inc MCP6541_MM_C.sub
