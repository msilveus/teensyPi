Version 4
SHEET 1 3508 1296
WIRE 1792 -272 1504 -272
WIRE 2048 -272 1888 -272
WIRE 2176 -272 2048 -272
WIRE 2496 -272 2176 -272
WIRE 2048 -256 2048 -272
WIRE 1792 -240 1712 -240
WIRE 16 -208 -160 -208
WIRE 112 -208 16 -208
WIRE 304 -208 112 -208
WIRE 1840 -192 1840 -208
WIRE 16 -160 16 -208
WIRE 112 -160 112 -208
WIRE 304 -160 304 -208
WIRE -160 -144 -160 -208
WIRE 256 -144 208 -144
WIRE 2048 -144 2048 -176
WIRE 1712 -96 1712 -240
WIRE 2320 -96 1712 -96
WIRE 16 -32 16 -80
WIRE 208 -32 208 -144
WIRE 208 -32 16 -32
WIRE 1888 -16 1888 -48
WIRE 1504 16 1504 -272
WIRE 1792 16 1504 16
WIRE 2048 16 1888 16
WIRE 2160 16 2048 16
WIRE 2496 16 2160 16
WIRE 2048 32 2048 16
WIRE 2752 32 2576 32
WIRE 1792 48 1712 48
WIRE 2752 48 2752 32
WIRE 304 64 304 -64
WIRE 16 96 16 -32
WIRE 1136 96 1072 96
WIRE 1248 96 1216 96
WIRE 1840 96 1840 80
WIRE 2576 96 2576 32
WIRE 2576 96 2384 96
WIRE 2320 128 2320 -96
WIRE 2656 128 2320 128
WIRE -256 144 -288 144
WIRE -208 144 -256 144
WIRE -48 144 -128 144
WIRE 2048 144 2048 112
WIRE 2656 160 2656 128
WIRE 304 192 304 144
WIRE 336 192 304 192
WIRE 448 192 336 192
WIRE 560 192 448 192
WIRE 704 192 640 192
WIRE 752 192 704 192
WIRE 816 192 752 192
WIRE 944 192 816 192
WIRE 1072 192 1072 96
WIRE 1072 192 1024 192
WIRE 1136 192 1072 192
WIRE 1712 192 1712 48
WIRE 2544 192 1712 192
WIRE 1248 208 1248 96
WIRE 1248 208 1200 208
WIRE 1280 208 1248 208
WIRE 1376 208 1280 208
WIRE 1488 208 1440 208
WIRE 1504 208 1504 16
WIRE 1504 208 1488 208
WIRE 304 224 304 192
WIRE 448 224 448 192
WIRE 704 224 704 192
WIRE 752 224 752 192
WIRE 1136 224 1104 224
WIRE 1504 224 1504 208
WIRE 2544 240 2544 192
WIRE 1168 272 1168 240
WIRE 304 336 304 304
WIRE 448 336 448 304
WIRE 1104 336 1104 224
WIRE 1104 336 1056 336
WIRE 1136 336 1104 336
WIRE 1232 336 1216 336
WIRE 1248 336 1232 336
WIRE 1232 384 1232 336
WIRE 1232 384 1168 384
WIRE -288 400 -288 144
WIRE 2384 400 2384 96
WIRE 2384 400 -288 400
FLAG 1168 272 0
FLAG 336 192 coil
FLAG 1280 208 preamp_out
FLAG -256 144 tx_pulse
FLAG 1168 176 +V
FLAG 1488 208 HPF_Out
FLAG 1840 -320 +V
FLAG 1840 -32 +V
FLAG 2656 240 0
FLAG 2544 320 0
FLAG 3008 -240 0
FLAG 3008 -320 +V
FLAG 2048 144 0
FLAG 2048 -144 0
FLAG 1840 -192 0
FLAG 1840 96 0
FLAG 2176 -272 MainSignal
FLAG 1712 -240 MainCtrl
FLAG 2160 16 EFESignal
FLAG 1712 48 EFECtrl
FLAG 2752 128 0
FLAG 816 192 preamp_in
FLAG -160 -64 0
FLAG 16 192 0
FLAG 304 336 0
FLAG 448 336 0
FLAG 704 288 0
FLAG 752 288 0
FLAG 1504 304 0
FLAG 1248 336 0
FLAG 976 336 +V
SYMBOL voltage -160 -160 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value 12
SYMBOL voltage 2752 32 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 3 -162 58 Left 2
SYMATTR Value PULSE(0 3.1 {TxDelay} 1n 1n {TxPulseWidth} {Period} {Cycles})
SYMATTR InstName V2
SYMBOL npn -48 96 R0
SYMATTR InstName Q1
SYMATTR Value 2n3904
SYMBOL res -112 128 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R1
SYMATTR Value 10K
SYMBOL res 32 -64 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R2
SYMATTR Value 1K
SYMBOL pmos 256 -64 M180
SYMATTR InstName M1
SYMATTR Value IRF9640
SYMBOL res 320 160 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R3
SYMATTR Value 3.3
SYMBOL cap 96 -160 R0
SYMATTR InstName C1
SYMATTR Value 1000µ
SYMATTR SpiceLine V=16
SYMBOL res 432 208 R0
SYMATTR InstName R4
SYMATTR Value 270
SYMBOL ind 288 208 R0
SYMATTR InstName L1
SYMATTR Value 300µ
SYMATTR SpiceLine Cpar=1n
SYMBOL diode 720 288 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D1
SYMATTR Value 1N4148
SYMBOL res 656 176 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R5
SYMATTR Value 1000
SYMBOL OpAmps\\LT1677 1168 144 R0
SYMATTR InstName U1
SYMBOL res 1040 176 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 10K
SYMBOL cap 1440 192 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C2
SYMATTR Value 470n
SYMBOL res 1488 208 R0
SYMATTR InstName R8
SYMATTR Value 10K
SYMBOL voltage 2656 144 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 3 -31 56 Left 2
SYMATTR Value PULSE(0 3.3 {MainDelay} 1n 1n {RxPulseWidth} {Period} {Cycles})
SYMATTR InstName V5
SYMBOL voltage 2544 224 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 3 -17 56 Left 2
SYMATTR Value PULSE(0 3.3 {EFEDelay} 1n 1n {RxPulseWidth} {Period} {Cycles})
SYMATTR InstName V6
SYMBOL CD4066 1840 -240 R0
SYMATTR InstName U6
SYMBOL CD4066 1840 48 R0
SYMATTR InstName U7
SYMBOL voltage 3008 -336 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 0 -60 29 Left 2
WINDOW 3 -18 56 Left 2
SYMATTR InstName V3
SYMATTR Value 3.3
SYMBOL res 1232 80 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value 33K
SYMBOL diode 736 224 R0
SYMATTR InstName D2
SYMATTR Value 1N4148
SYMBOL res 2032 -272 R0
SYMATTR InstName R9
SYMATTR Value 100K
SYMBOL res 2032 16 R0
SYMATTR InstName R10
SYMATTR Value 100K
SYMBOL res 1072 320 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R11
SYMATTR Value 100K
SYMBOL potentiometer 1232 320 R90
WINDOW 0 -13 32 VRight 2
WINDOW 3 50 -105 VRight 2
SYMATTR InstName R12
SYMATTR Value Rtot=10K wiper=.25
TEXT 2568 -344 Left 2 !.tran 0 500m 0 1u startup
TEXT -248 496 Left 2 !.lib\n* CD4066 Analog Switch\n* SYM=CD4066\n* Transistor models are from LTspice group member kcin_melnick\n* See message number 16897, http://tech.groups.yahoo.com/group/LTspice/\n* Analog Switch Control In Out Vdd Vss\n.SUBCKT CD4066 2 11 4 10 7\nX1 2 6 10 7 INVERT\nX2 6 1 10 7 INVERT\nM1 14 6 7 7 CD4007N\nM7 11 6 14 10 CD4007P\nM3 11 1 14 14 CD4007N\nM4 11 1 4 14 CD4007N\nM8 11 6 4 10 CD4007P\n.SUBCKT INVERT 1 2 3 4\n* Inverter In Out Vcc Vss\nM1 2 1 3 3 CD4007P\nM2 2 1 4 4 CD4007N\n.ENDS\n.MODEL CD4007N NMOS (\n+ LEVEL=1 VTO=1.44 KP=320u L=10u W=30u GAMMA=0 PHI=.6 LAMBDA=10m\n+ RD=23.2 RS=90.1 IS=16.64p CBD=2.0p CBS=2.0p CGSO=0.1p CGDO=0.1p\n+ PB=.8 TOX=1200n)\n \n.MODEL CD4007P PMOS (\n+ LEVEL=1 VTO=-1.2 KP=110u L=10U W=60U GAMMA=0 PHI=.6 LAMBDA=40m\n+ RD=21.2 RS=62.2 IS=16.64P CBD=4.0P CBS=4.0P CGSO=0.2P CGDO=0.2P\n+ PB=.8 TOX=1200N)\n.ENDS
TEXT 0 -296 Left 2 ;Tx Driver
TEXT 880 504 Left 2 !.lib\n* This is the potentiometer\n*      _____\n*  1--|_____|--2\n*        |\n*        3\n*\n.SUBCKT potentiometer 1 2 3\n.param w=limit(wiper,1m,.999)\nR0 1 3 {Rtot*(1-w)}\nR1 3 2 {Rtot*(w)}\n.ENDS
TEXT 2568 -248 Left 2 !.param TxDelay 0u
TEXT 2568 -152 Left 2 !.param MainDelay {TxDelay+TxPulseWidth+10u}
TEXT 2568 -128 Left 2 !.param EFEDelay {MainDelay+50u}
TEXT 2568 -224 Left 2 !.param TxPulseWidth 50u
TEXT 2568 -200 Left 2 !.param Period 500u
TEXT 2568 -176 Left 2 !.param Cycles 2000
TEXT 2568 -104 Left 2 !.param RxPulseWidth 10u
TEXT 2720 -408 Left 2 ;MCU
TEXT 2504 -272 Left 2 ;A0
TEXT 2504 16 Left 2 ;A1
TEXT 1440 544 Left 2 !.meas TRAN Integral_MainSignal INTEG V(MainVoltageCurve)
TEXT 1440 576 Left 2 !.meas TRAN Duration_MainCtrl INTEG V(MainPulseDuration)
TEXT 1440 608 Left 2 !.meas TRAN AVG_MainSignal PARAM Integral_MainSignal / Duration_MainCtrl
TEXT 1448 480 Left 2 !B1 MainVoltageCurve 0 V = V(MainSignal) * (V(MainCtrl) > 2.5)
TEXT 1448 512 Left 2 !B2 MainPulseDuration 0 V = (V(MainCtrl) > 2.5)
TEXT 1440 720 Left 2 !.meas TRAN Integral_EFESignal INTEG V(EFEVoltageCurve)
TEXT 1440 752 Left 2 !.meas TRAN Duration_EFECtrl INTEG V(EFEPulseDuration)
TEXT 1440 784 Left 2 !.meas TRAN AVG_EFESignal PARAM Integral_EFESignal / Duration_EFECtrl
TEXT 1448 656 Left 2 !B3 EFEVoltageCurve 0 V = V(EFESignal) * (V(EFECtrl) > 2.5)
TEXT 1448 688 Left 2 !B4 EFEPulseDuration 0 V = (V(EFECtrl) > 2.5)
TEXT 1440 1096 Left 2 !.meas TRAN Coil_MAX_Voltage MAX V(coil)
TEXT 1440 1120 Left 2 !.meas TRAN Coil_MIN_Voltage MIN V(coil)
TEXT 1440 856 Left 2 !.meas TRAN R4_AVG_CURRENT AVG I(R4)
TEXT 1440 832 Left 2 !.meas TRAN R3_AVG_CURRENT AVG I(R3)
TEXT 1440 1024 Left 2 !.meas TRAN HPF_OUT_MAX MAX V(HPF_Out)
TEXT 1440 1048 Left 2 !.meas TRAN HPF_OUT_MIN MIN V(HPF_Out)
TEXT 1440 880 Left 2 !.meas TRAN R5_AVG_CURRENT AVG I(R5)
TEXT 1440 904 Left 2 !.meas TRAN D1_AVG_CURRENT AVG I(D1)
TEXT 1440 928 Left 2 !.meas TRAN D2_AVG_CURRENT AVG I(D2)
TEXT 1440 952 Left 2 !.meas TRAN R3_MAX_CURRENT MAX I(R3)
TEXT 1440 976 Left 2 !.meas TRAN R4_MAX_CURRENT MAX I(R4)
TEXT 1440 1000 Left 2 !.meas TRAN L1_MAX_CURRENT MAX I(L1)
TEXT 1440 1072 Left 2 !.meas TRAN PreAmpIn_MIN MIN V(preamp_in)
TEXT 2504 80 Left 2 ;D2
TEXT 2504 112 Left 2 ;D3
TEXT 2504 176 Left 2 ;D4
RECTANGLE Normal -224 -320 384 416 2
RECTANGLE Normal 2464 -384 3072 352 2
